services:

    redis:
        image: 'redis:alpine'
        ports:
            - '${FORWARD_REDIS_PORT:-6379}:6379'
        volumes:
            - 'tubular-redis:/data'
        networks:
            - sail
        healthcheck:
            test:
                - CMD
                - redis-cli
                - ping
            retries: 3
            timeout: 5s
    tubular:
        build:
            context: '.'
            dockerfile: Dockerfile
        restart: unless-stopped
        ports:
            - '${TUBULAR_CALLBACK_PORT:-9181}:${TUBULAR_CALLBACK_PORT:-9181}'
        environment:
            YOUTUBE_API_KEY: '${YOUTUBE_API_KEY:-}'
            YOUTUBE_CHANNEL_ID: '${YOUTUBE_CHANNEL_ID:-}'
            TUBULAR_WEBHOOK_URL: '${TUBULAR_WEBHOOK_URL:-http://streamdelta/webhooks/youtube}'
            WEBHOOK_SECRET: '${TUBULAR_WEBHOOK_SECRET:-}'
            TUBULAR_CALLBACK_URL: '${TUBULAR_CALLBACK_URL:-}'
            TUBULAR_CALLBACK_PORT: '${TUBULAR_CALLBACK_PORT:-9181}'
            YOUTUBE_POLL_INTERVAL: '${YOUTUBE_POLL_INTERVAL:-180}'
            CALLBACK_BIND_ADDRESS: ''
            REDIS_HOST: ${REDIS_HOST:-redis}
            REDIS_PORT: ${REDIS_PORT:-6379}
            REDIS_PASSWORD: ${REDIS_PASSWORD:-''}
            REDIS_DB: ${REDIS_DB:-0}
            TUBULAR_HEARTBEAT_INTERVAL: '${TUBULAR_HEARTBEAT_INTERVAL:-30}'
            TUBULAR_LOG_FILE: '/var/log/tubular/tubular.log'
            TUBULAR_LOG_LEVEL: '${TUBULAR_LOG_LEVEL:-INFO}'
        volumes:
            - 'tubular-logs:/var/log/tubular:rw'
        networks:
            - sail
        depends_on:
            - redis
networks:
    sail:
        driver: bridge
volumes:
    tubular-redis:
        driver: local
    tubular-logs:
        driver: local
        driver_opts:
            type: 'none'
            device: './logs'
            o: 'bind'